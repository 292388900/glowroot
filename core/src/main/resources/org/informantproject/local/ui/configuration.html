<!doctype html>
<!--
  Copyright 2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Informant | Configuration</title>
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="libs/bootstrap/2.1.1/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="css/informant.css" type="text/css" />
<script type="text/javascript" src="libs/jquery/1.8.1/jquery.min.js"></script>
<script type="text/javascript" src="libs/bootstrap/2.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="libs/handlebars/1.0.0.beta.6/handlebars.js"></script>
<script type="text/javascript" src="libs/spin/1.2.6/spin.min.js"></script>
<script type="text/javascript" src="js/informant.js"></script>
<script id="pluginTemplate" type="text/x-handlebars-template">
<br>
<div>
  <span style="vertical-align: middle; font-size: 19px">{{name}}</span>
  <span class="btn-group" style="display: inline-block; margin-left: 10px; vertical-align: middle">
    <button id="{{id}}_enabled_on" class="btn btn-on">ON</button>
    <button id="{{id}}_enabled_off" class="btn btn-off">OFF</button>
  </span>
  <span id="{{id}}_enableComplete" class="button-success-message">
    Enabled
  </span>
  <span id="{{id}}_disableComplete" class="button-success-message" style="color: gray">
    Disabled
  </span>
</div>
<br>
{{#if propertyDescriptors}}
  <form class="well form-horizontal" style="margin-left: 40px">
    <fieldset>
      {{#each propertyDescriptors}}
        {{#ifString type}}
          <div class="control-group">
            <label class="control-label" for="{{../../id}}_{{name}}">{{prompt}}</label>
            <div class="controls">
              <input style="width: 12em" id="{{../../id}}_{{name}}" type="text">
              {{#if description}}
                <div class="help-block">
                  {{description}}
                </div>
              {{/if}}
            </div>
          </div>
        {{/ifString}}
        {{#ifBoolean type}}
          <div class="control-group">
            <label class="control-label" for="{{../../id}}_{{name}}">{{prompt}}</label>
            <div class="controls">
              <input id="{{../../id}}_{{name}}" type="checkbox" value="true">
              {{#if description}}
                <div class="help-block">
                  {{description}}
                </div>
              {{/if}}
            </div>
          </div>
        {{/ifBoolean}}
        {{#ifDouble type}}
          <div class="control-group">
            <label class="control-label" for="{{../../id}}_{{name}}">{{prompt}}</label>
            <div class="controls">
              <input style="width: 6em" id="{{../../id}}_{{name}}" type="text">
              {{#if description}}
                <div class="help-block">
                  {{description}}
                </div>
              {{/if}}
            </div>
          </div>
        {{/ifDouble}}
      {{/each}}
      <div class="form-actions">
        <button type="button" class="btn" onclick="updatePluginConfig('{{id}}')">
          Save changes
        </button>
        <div id="{{id}}_saveComplete" class="button-success-message">Saved</div>
      </div>
    </fieldset>
  </form>
{{/if}}
</script>
<script type="text/javascript">
  Handlebars.registerHelper('ifString', function(type, options) {
    if (type == 'string') {
      return options.fn(this)
    } else {
      return options.inverse(this)
    }
  })
  Handlebars.registerHelper('ifBoolean', function(type, options) {
    if (type == 'boolean') {
      return options.fn(this)
    } else {
      return options.inverse(this)
    }
  })
  Handlebars.registerHelper('ifDouble', function(type, options) {
    if (type == 'double') {
      return options.fn(this)
    } else {
      return options.inverse(this)
    }
  })
  var pluginTemplate = Handlebars.compile($('#pluginTemplate').html())
  var plugins
  function escapeForSelector(id) {
    // '.' and ':' have to be escaped for jquery selectors
    return id.replace(/\./g, '\\.').replace(/:/g, '\\:')
  }
  function setUpOnOffButton(selectorPrefix, initialValue, urlPrefix) {
    if (initialValue) {
      $('#' + selectorPrefix + 'enabled_on').addClass('active')
    } else {
      $('#' + selectorPrefix + 'enabled_off').addClass('active')
    }
    $('#' + selectorPrefix + 'enabled_on').click(function() {
      if ($('#' + selectorPrefix + 'enabled_on').hasClass('active')) {
        return
      }
      $.post(urlPrefix + '/enable', function() {
        $('#' + selectorPrefix + 'enabled_off').removeClass('active')
        $('#' + selectorPrefix + 'enabled_on').addClass('active')
        // in case user toggles back and forth between enable/disable
        $('#' + selectorPrefix + 'disableComplete').hide()
        showAndFadeSuccessMessage('#' + selectorPrefix + 'enableComplete')
      })
    })
    $('#' + selectorPrefix + 'enabled_off').click(function() {
      if ($('#' + selectorPrefix + 'enabled_off').hasClass('active')) {
        return
      }
      $.post(urlPrefix + '/disable', function() {
        $('#' + selectorPrefix + 'enabled_on').removeClass('active')
        $('#' + selectorPrefix + 'enabled_off').addClass('active')
        // in case user toggles back and forth between enable/disable
        $('#' + selectorPrefix + 'enableComplete').hide()
        showAndFadeSuccessMessage('#' + selectorPrefix + 'disableComplete')
      })
    })
  }
  function read() {
    $.getJSON('config/read', function(config) {
      var coreConfig = config.coreConfig
      setUpOnOffButton('', coreConfig.enabled, 'config/core')
      $('#persistenceThresholdMillis').val(coreConfig.persistenceThresholdMillis)
      $('#stuckThresholdSeconds').val(coreConfig.stuckThresholdSeconds)
      $('#spanStackTraceThresholdMillis').val(coreConfig.spanStackTraceThresholdMillis)
      $('#maxEntries').val(coreConfig.maxEntries)
      $('#rollingSizeMb').val(coreConfig.rollingSizeMb)
      $('#offscreenMeasure').text(config.dataDirFolder)
      $('#dataDirFolder').text(config.dataDirFolder)
      $('#dataDirFolder').css("width", ($('#offscreenMeasure').width() + 50) + "px")
      var coarseProfilingConfig = config.coarseProfilingConfig
      setUpOnOffButton('profiling_coarse_', coarseProfilingConfig.enabled,
          'config/profiling/coarse')
      $('#coarseInitialDelayMillis').val(coarseProfilingConfig.initialDelayMillis)
      $('#coarseIntervalMillis').val(coarseProfilingConfig.intervalMillis)
      $('#coarseTotalSeconds').val(coarseProfilingConfig.totalSeconds)
      var fineProfilingConfig = config.fineProfilingConfig
      setUpOnOffButton('profiling_fine_', fineProfilingConfig.enabled, 'config/profiling/fine')
      $('#fineTracePercentage').val(fineProfilingConfig.tracePercentage)
      $('#fineIntervalMillis').val(fineProfilingConfig.intervalMillis)
      $('#fineTotalSeconds').val(fineProfilingConfig.totalSeconds)
      if (fineProfilingConfig.persistenceThresholdMillis == -1) {
        $('#finePersistenceThresholdMillis').attr('readonly','readonly')
      } else {
        $('#finePersistenceThresholdOverride').attr('checked', true)
        $('#finePersistenceThresholdMillis').val(fineProfilingConfig.persistenceThresholdMillis)
      }
      plugins = config.pluginDescriptors
      for (var i = 0; i < plugins.length; i++) {
        var plugin = plugins[i]
        plugin.id = plugin.groupId + ':' + plugin.artifactId
        var propertyDescriptors = []
        for (var j = 0; j < plugin.propertyDescriptors.length; j++) {
          if (!plugin.propertyDescriptors[j].hidden) {
            propertyDescriptors.push(plugin.propertyDescriptors[j])
          }
        }
        plugin.propertyDescriptors = propertyDescriptors
        var html = pluginTemplate(plugin)
        $('#plugins').append(html)
        setUpOnOffButton(escapeForSelector(plugin.id) + '_',
            config.pluginConfigs[plugin.id].enabled, 'config/plugin/' + plugin.id)
        var pluginConfig = config.pluginConfigs[plugin.id]
        for (var j = 0; j < plugin.propertyDescriptors.length; j++) {
          var propertyDescriptors = plugin.propertyDescriptors[j]
          var value = pluginConfig[propertyDescriptors.name]
          if (propertyDescriptors.type == 'boolean') {
            $('#' + escapeForSelector(plugin.id + '_' + propertyDescriptors.name)).attr('checked',
                value)
          } else {
            $('#' + escapeForSelector(plugin.id + '_' + propertyDescriptors.name)).val(value)
          }
        }
      }
    })
  }
  // updateCoreConfig can take a while if resizing large rolling database
  var postingUpdateCore = false
  function updateCoreConfig() {
    // handling crazy user clicking on the button
    if (postingUpdateCore) return
    postingUpdateCore = true
    var config = {
      'persistenceThresholdMillis': $('#persistenceThresholdMillis').val(),
      'stuckThresholdSeconds': $('#stuckThresholdSeconds').val(),
      'spanStackTraceThresholdMillis': $('#spanStackTraceThresholdMillis').val(),
      'maxEntries': $('#maxEntries').val(),
      'rollingSizeMb': $('#rollingSizeMb').val()
    }
    $.post('config/core', JSON.stringify(config), function() {
      postingUpdateCore = false
      hideSpinner('#saveCoreButtonSpinner')
      showAndFadeSuccessMessage('#saveCoreComplete')
    })
    // in case button is clicked again before success message is hidden
    $('#saveCoreComplete').hide()
    showSpinner('#saveCoreButtonSpinner')
  }
  function updateCoarseProfilingConfig() {
    var config = {
      'initialDelayMillis': $('#coarseInitialDelayMillis').val(),
      'intervalMillis': $('#coarseIntervalMillis').val(),
      'totalSeconds': $('#coarseTotalSeconds').val()
    }
    $.post('config/profiling/coarse', JSON.stringify(config), function() {
      showAndFadeSuccessMessage('#saveCoarseProfilingComplete')
    })
  }
  function updateFineProfilingConfig() {
    var persistenceThresholdMillis = $('#finePersistenceThresholdMillis').val()
    if (!persistenceThresholdMillis) {
      persistenceThresholdMillis = -1
    }
    var config = {
      'tracePercentage': $('#fineTracePercentage').val(),
      'intervalMillis': $('#fineIntervalMillis').val(),
      'totalSeconds': $('#fineTotalSeconds').val(),
      'persistenceThresholdMillis': persistenceThresholdMillis
    }
    $.post('config/profiling/fine', JSON.stringify(config), function() {
      showAndFadeSuccessMessage('#saveFineProfilingComplete')
    })
  }
  function updatePluginConfig(pluginId) {
    var plugin = pluginForId(pluginId)
    var config = {}
    for (var j = 0; j < plugin.propertyDescriptors.length; j++) {
      var propertyDescriptors = plugin.propertyDescriptors[j]
      if (!propertyDescriptors.hidden) {
        var value
        if (propertyDescriptors.type == 'boolean') {
          value = $('#' + escapeForSelector(plugin.id + '_' + propertyDescriptors.name)).is(
              ':checked')
        } else if (propertyDescriptors.type == 'double') {
          value = parseFloat($('#' + escapeForSelector(plugin.id + '_' + propertyDescriptors.name))
              .val())
        } else {
          value = $('#' + escapeForSelector(plugin.id + '_' + propertyDescriptors.name)).val()
        }
        config[propertyDescriptors.name] = value
      }
    }
    $.post('config/plugin/' + pluginId, JSON.stringify(config),
        function() {
          showAndFadeSuccessMessage('#' + escapeForSelector(pluginId) + '_saveComplete')
        })
  }
  function pluginForId(pluginId) {
    for (var i = 0; i < plugins.length; i++) {
      if (plugins[i].id == pluginId) {
        return plugins[i]
      }
    }
    return null
  }
  $(document).ready(function() {
    configureAjaxError()
    $('#finePersistenceThresholdOverride').change(function() {
      if ($('#finePersistenceThresholdOverride').is(':checked')) {
        $('#finePersistenceThresholdMillis').removeAttr('readonly')
      } else {
        $('#finePersistenceThresholdMillis').val('')
        $('#finePersistenceThresholdMillis').attr('readonly','readonly')
      }
    })
    read()
  })
</script>
</head>
<body>
  <h1 class="header">
    <a class="header-logo" href=".">Informant</a><span class="header-page-name">Configuration</span>
    <span class="header-see-also">see also: <a href="traces.html">trace explorer</a></span>
  </h1>
  <div>
    <span class="btn-group" style="display: inline-block; vertical-align: middle">
      <button id="enabled_on" class="btn btn-on">ON</button>
      <button id="enabled_off" class="btn btn-off">OFF</button>
    </span>
    <span id="enableComplete" class="button-success-message">
      Enabled
    </span>
    <span id="disableComplete" class="button-success-message" style="color: gray">
      Disabled
    </span>
  </div>
  <br>
  <form class="well form-horizontal">
    <fieldset>
      <div class="control-group">
        <label class="control-label" for="persistenceThresholdMillis">Persistence threshold</label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="persistenceThresholdMillis"
              type="text"><span class="add-on">milliseconds</span>
          </div>
          <span class="help-block">
            Any trace that exceeds this amount of time will be viewable in the trace explorer
            immediately as an active trace and will be persisted to disk at its completion.
          </span>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="stuckThresholdSeconds">Stuck threshold</label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="stuckThresholdSeconds"
              type="text"><span class="add-on">seconds</span>
          </div>
          <div class="help-block">
            Any trace that exceeds this amount of time will be persisted to disk immediately (prior
            to its completion). This is to guard against threads which get stuck forever (or at
            least long enough and do enough harm to the jvm that it has to be restarted).
          </div>
        </div>
      </div>
      <div class="control-group" style="display: none">
        <label class="control-label" for="spanStackTraceThresholdMillis">
          Span stack trace threshold
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="spanStackTraceThresholdMillis"
              type="text"><span class="add-on">milliseconds</span>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="maxEntries">Max trace entries</label>
        <div class="controls">
          <input style="width: 6em" id="maxEntries" type="text">
          <div class="help-block">
            Maximum number of trace entries collected for a given trace. This is useful for limiting
            the memory requirement of very very long traces that capture potentially hundreds of
            thousands of trace entries (e.g. large batch or background operations).
            Also, the trace explorer is not really optimized for viewing super large numbers of
            trace entries.
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="rollingSizeMb">Rolling database size</label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="rollingSizeMb" type="text"><span class="add-on">MB</span>
          </div>
          <div class="help-block">
            Trace detail data (trace entries, sampled profile) is persisted to disk as
            LZF-compressed json data in a rolling data file to efficiently cap the growth of this
            large data. (Trace summary data - capture time, duration, description, username,
            attributes, metrics - is persisted to an H2 data file by the embedded H2 database
            engine.)
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="dataDirFolder">Data dir folder</label>
        <div class="controls">
          <span class="uneditable-input" id="dataDirFolder"></span>
          <div class="help-block">
            The data dir folder must be set on the command line, e.g.
            -javaagent:informant.jar=data.dir:&lt;folder&gt;
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="updateCoreConfig()">Save changes</button>
        <div id="saveCoreButtonSpinner" class="button-spinner"></div>
        <div id="saveCoreComplete" class="button-success-message">Saved</div>
      </div>
    </fieldset>
  </form>
  <div>
    <span style="vertical-align: middle; font-size: 19px">Coarse-Grained Profiling</span>
    <span class="btn-group"
        style="display: inline-block; margin-left: 10px; vertical-align: middle">
      <button id="profiling_coarse_enabled_on" class="btn btn-on">ON</button>
      <button id="profiling_coarse_enabled_off" class="btn btn-off">OFF</button>
    </span>
    <span id="profiling_coarse_enableComplete" class="button-success-message">
      Enabled
    </span>
    <span id="profiling_coarse_disableComplete" class="button-success-message" style="color: gray">
      Disabled
    </span>
  </div>
  <br>
  <form class="well form-horizontal" style="margin-left: 40px">
    <fieldset>
      <div class="control-group">
        <label class="control-label" for="coarseInitialDelayMillis">
          Initial delay
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="coarseInitialDelayMillis"
                type="text"><span class="add-on">milliseconds</span>
          </div>
          <div class="help-block">
            Once a trace exceeds this amount of time, the coarse profiler captures stack traces
            periodically.
            The interval between successive stack trace captures is defined by the property directly
            below.
            The stack traces captured for an individual trace are merged into a tree view and
            provide a profile of the time spent in various portions of the code.
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="coarseIntervalMillis">
          Interval
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="coarseIntervalMillis"
                type="text"><span class="add-on">milliseconds</span>
          </div>
          <div class="help-block">
            The interval at which the coarse profiler captures stack traces (once a trace exceeds
            the initial delay directly above).
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="coarseTotalSeconds">
          Total
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="coarseTotalSeconds"
                type="text"><span class="add-on">seconds</span>
          </div>
          <div class="help-block">
            The total length of time that the coarse profiler captures stack traces (once a trace
            exceeds the initial delay above).
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="updateCoarseProfilingConfig()">
          Save changes
        </button>
        <div id="saveCoarseProfilingComplete" class="button-success-message">Saved</div>
      </div>
    </fieldset>
  </form>
  <div>
    <span style="vertical-align: middle; font-size: 19px">Fine-Grained Profiling</span>
    <span class="btn-group"
        style="display: inline-block; margin-left: 10px; vertical-align: middle">
      <button id="profiling_fine_enabled_on" class="btn btn-on">ON</button>
      <button id="profiling_fine_enabled_off" class="btn btn-off">OFF</button>
    </span>
    <span id="profiling_fine_enableComplete" class="button-success-message">
      Enabled
    </span>
    <span id="profiling_fine_disableComplete" class="button-success-message" style="color: gray">
      Disabled
    </span>
  </div>
  <br>
  <form class="well form-horizontal" style="margin-left: 40px">
    <fieldset>
      <div class="control-group">
        <label class="control-label" for="fineTracePercentage">
          Trace percentage
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="fineTracePercentage"
                type="text"><span class="add-on">%</span>
          </div>
          <div class="help-block">
            Apply fine grained profiling to this percentage of traces.
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="fineIntervalMillis">
          Interval
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="fineIntervalMillis"
                type="text"><span class="add-on">milliseconds</span>
          </div>
          <div class="help-block">
            The interval at which the fine grained profiler captures stack traces (once a trace
            exceeds the initial delay directly above).
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="fineTotalSeconds">
          Total
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="fineTotalSeconds"
                type="text"><span class="add-on">seconds</span>
          </div>
          <div class="help-block">
            The total length of time that the fine grained profiler captures stack traces (once a
            trace exceeds the initial delay above).
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="finePersistenceThresholdMillis">
          Persistence threshold
        </label>
        <div class="controls">
          <div style="padding-top: 5px; padding-bottom: 5px">
            <label class="checkbox">
              <input id="finePersistenceThresholdOverride" type="checkbox" value="true">
              Override general persistence threshold
            </label>
          </div>
          <div class="input-append">
            <input style="width: 6em" id="finePersistenceThresholdMillis"
                type="text"><span class="add-on">milliseconds</span>
          </div>
          <div class="help-block">
            After going through the trouble of collecting fine-grained profiling info, it may be
            worthwhile to persist the given trace even if it doesn't hit the general persistence
            threshold.
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="updateFineProfilingConfig()">
          Save changes
        </button>
        <div id="saveFineProfilingComplete" class="button-success-message">Saved</div>
      </div>
    </fieldset>
  </form>
  <div id="plugins"></div>
  <span id="offscreenMeasure" style="position: absolute; left: -10000px; top: 0px"></span>
</body>
</html>
