<!doctype html>
<!--
  Copyright 2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Informant | Traces</title>
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="bootstrap/2.0.0/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="css/informant.css" type="text/css" />
<link rel="stylesheet" href="jqueryui/1.8.17/ui-lightness/jquery-ui.all.css" type="text/css" />
<script type="text/javascript" src="jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="bootstrap/2.0.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="jqueryui/1.8.17/jquery-ui.all.min.js"></script>
<script type="text/javascript" src="dateformat/1.2.3/date.format.js"></script>
<script type="text/javascript" src="handlebars/1.0.0.beta.6/handlebars.js"></script>
<!--[if lte IE 8]>
<script type="text/javascript" src="flot/0.7.1-informant-01/excanvas.min.js"></script>
<![endif]-->
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.navigate.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.resize.min.js"></script>
<script type="text/javascript" src="js/traces.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    var plot, selection, activeTraceDurations

    var options = {
      legend: { show: false },
      series: {
        points: { show: true }
      },
      xaxis: { mode: 'time' },
      yaxis: { ticks: 10, zoomRange : false },
      zoom: { interactive: true, amount : 1.5 },
      selection: { mode: 'xy' }
    }
    function plotFullDate(date) {
      var from = date.getTime()
      var to = from + 24 * 60 * 60 * 1000; // from + 24 hours
      getTraceDurations(from, to)
    }
    function plotResponseData(storedTraceDurations, activeTraceDurations) {
      var overrideOptions = {}
      if (storedTraceDurations.length || activeTraceDurations.length) {
        var xmin
        var xmax
        if (storedTraceDurations.length) {
          xmin = storedTraceDurations[0][0]
          xmax = storedTraceDurations[storedTraceDurations.length - 1][0]
        }
        if (activeTraceDurations.length) {
          xmin = Math.min(xmin, activeTraceDurations[0][0])
          xmax = Math.max(xmax, activeTraceDurations[activeTraceDurations.length - 1][0])
        }
        overrideOptions = {
          xaxis: { zoomRange : [ xmin, xmax ] }
        }
      }
      plot = $.plot($('#placeholder'), [storedTraceDurations, activeTraceDurations],
          $.extend(true, {}, options, overrideOptions))
      selection = null
    }
    $('#placeholder').bind("plotselected", function(event, ranges) {
      selection = ranges
    })
    $('#placeholder').bind("plotunselected", function(event, ranges) {
      selection = null
    })
    $('#placeholder').bind('plotzoom', function (event, plot) {
      if (selection)
        plot.setSelection(selection)
    })
    function getTraceDurations(from, to) {
      $.getJSON('/trace/durations?from=' + from + '&to=' + to, function(response) {
        var storedTraceDurations = response.storedTraceDurations
        activeTraceDurations = response.activeTraceDurations
        // shift for timezone
        for (var i = 0; i < storedTraceDurations.length; i++) {
          storedTraceDurations[i][0] -= new Date(storedTraceDurations[i][0]).getTimezoneOffset()
              * 60 * 1000
        }
        for (var i = 0; i < activeTraceDurations.length; i++) {
          activeTraceDurations[i][0] -= new Date(activeTraceDurations[i][0]).getTimezoneOffset()
              * 60 * 1000
        }
        plotResponseData(storedTraceDurations, activeTraceDurations)
      })
      $('#traces').html('')
    }
    function getTraceDetails() {
      var from, to, low, high
      var extraIds = []
      if (selection) {
        from = selection.xaxis.from + new Date(selection.xaxis.from).getTimezoneOffset() * 60 * 1000
        to = selection.xaxis.to + new Date(selection.xaxis.to).getTimezoneOffset() * 60 * 1000
        // low, high are expected in milliseconds
        low = selection.yaxis.from * 1000
        high = selection.yaxis.to * 1000
        // add live traces inside the selection
        for (var i = 0; i < activeTraceDurations.length; i++) {
          if (activeTraceDurations[i][0] >= selection.xaxis.from
              && activeTraceDurations[i][0] <= selection.xaxis.to
              && activeTraceDurations[i][1] >= selection.yaxis.from
              && activeTraceDurations[i][1] <= selection.yaxis.to) {
            extraIds.push(activeTraceDurations[i][2])
          }
        }
      } else {
        var axes = plot.getAxes()
        from = axes.xaxis.min + new Date(axes.xaxis.min).getTimezoneOffset() * 60 * 1000
        to = axes.xaxis.max + new Date(axes.xaxis.max).getTimezoneOffset() * 60 * 1000
        // low, high are expected in milliseconds
        low = axes.yaxis.min * 1000
        high = axes.yaxis.max * 1000
        // add live traces inside the current view
        for (var i = 0; i < activeTraceDurations.length; i++) {
          if (activeTraceDurations[i][0] >= axes.xaxis.min
              && activeTraceDurations[i][0] <= axes.xaxis.max
              && activeTraceDurations[i][1] >= axes.yaxis.min
              && activeTraceDurations[i][1] <= axes.yaxis.max) {
            extraIds.push(activeTraceDurations[i][2])
          }
        }
      }
      var query = 'from=' + Math.floor(from) + '&to=' + Math.ceil(to) + '&low=' + low + '&high='
        + high
      if (extraIds) {
        query += "&extra_ids=" + extraIds
      }
      $.getJSON('/trace/details?' + query, function(response) {
        traces = response
        $('#traces').html('')
        if (traces.length) {
          html = tracesTemplate(traces)
          $(html).appendTo('#traces')
        } else {
          $('#traces').html('no data')
        }
      })
    }
    $('#datePicker').datepicker({ onSelect : function(dateText, inst) {
      plotFullDate($(this).datepicker('getDate'))
    }})
    $('#showDetails').click(function() {
      getTraceDetails()
    })
    var d = new Date()
    d.setHours(0,0,0,0)
    $('#datePicker').datepicker('setDate', d)
    plotFullDate(d)
  })
</script>
</head>
<body>
  <h1 class="header">
    <a class="header-logo" href="/">Informant</a><span class="header-page-name">Traces</span>
    <span class="header-see-also">see also: <a href="configuration.html">Configuration</a></span>
  </h1>
  <div>
    Date: <input style="width: 7em" type="text" id="datePicker">
  </div>
  <br>
  <div>
    <div id="placeholder" style="height: 300px"></div>
  </div>
  <br>
  <button class="btn" id="showDetails">Show Details</button>
  <br>
  <br>
  <div id="traces"></div>
  <div id="stacktracemodal" class="modal hide fade"
    style="width: 800px; margin: -300px 0 0 -400px; max-height: 600px">
    <div class="modal-header">
      <a class="close" data-dismiss="modal">Ã—</a>
      <h3>Stack Trace</h3>
    </div>
    <div id="stacktrace" class="modal-body"></div>
    <div class="modal-footer">
      <a href="#" class="btn">Close</a>
    </div>
  </div>
</body>
</html>
