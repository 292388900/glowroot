<!doctype html>
<!--
  Copyright 2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Informant | Traces</title>
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="bootstrap/2.0.2/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="css/informant.css" type="text/css" />
<link rel="stylesheet" href="jqueryui/1.8.17/ui-lightness/jquery-ui.all.css" type="text/css" />
<script type="text/javascript" src="jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="bootstrap/2.0.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="jqueryui/1.8.17/jquery-ui.all.min.js"></script>
<script type="text/javascript" src="dateformat/1.2.3/date.format.js"></script>
<script type="text/javascript" src="handlebars/1.0.0.beta.6/handlebars.js"></script>
<!--[if lte IE 8]>
<script type="text/javascript" src="flot/0.7.1-informant-01/excanvas.min.js"></script>
<![endif]-->
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.navigate.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.resize.min.js"></script>
<script type="text/javascript" src="js/traces.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    var plot, selection, activeTraceDurations

    var options = {
      legend: { show: false },
      series: {
        points: { show: true }
      },
      xaxis: { mode: 'time' },
      yaxis: { ticks: 10, zoomRange : false },
      zoom: { interactive: true, amount : 1.5 },
      selection: { mode: 'xy' }
    }
    function plotFullDate(date) {
      var from = date.getTime()
      var to = from + 24 * 60 * 60 * 1000; // from + 24 hours
      getTraceDurations(from, to)
    }
    function plotResponseData(storedTraceDurations, activeTraceDurations, from, to) {
      var fromAsDate = new Date(from)
      fromAsDate.setHours(0,0,0,0)
      var zoomRangeFrom = fromAsDate.getTime()
      var zoomRangeTo = zoomRangeFrom + 24 * 60 * 60 * 1000; // zoomRangeFrom + 24 hours
      from -= new Date(from).getTimezoneOffset() * 60 * 1000
      to -= new Date(to).getTimezoneOffset() * 60 * 1000
      zoomRangeFrom -= new Date(zoomRangeFrom).getTimezoneOffset() * 60 * 1000
      zoomRangeTo -= new Date(zoomRangeTo).getTimezoneOffset() * 60 * 1000
      overrideOptions = {
        xaxis: { min : from, max : to, zoomRange : [ zoomRangeFrom, zoomRangeTo ] }
      }
      plot = $.plot($('#placeholder'), [storedTraceDurations, activeTraceDurations],
          $.extend(true, {}, options, overrideOptions))
      updateTimeFilter()
      selection = null
    }
    $('#placeholder').bind("plotselected", function(event, ranges) {
      selection = ranges
    })
    $('#placeholder').bind("plotunselected", function(event, ranges) {
      selection = null
    })
    $('#placeholder').bind('plotzoom', function (event, plot) {
      if (selection) {
        plot.setSelection(selection)
      }
      updateTimeFilter()
    })
    function updateTimeFilter() {
      var from = Math.floor(plot.getAxes().xaxis.min)
      var to = Math.ceil(plot.getAxes().xaxis.max)
      // shift timezone
      from += new Date(from).getTimezoneOffset() * 60 * 1000
      to += new Date(to).getTimezoneOffset() * 60 * 1000
      $('#timeFilter').html(new Date(from).format('h:MM:ss TT') + ' &nbsp; to &nbsp; '
          + new Date(to).format('h:MM:ss TT (Z)'))
    }
    function refresh() {
      var from = Math.floor(plot.getAxes().xaxis.min)
      var to = Math.ceil(plot.getAxes().xaxis.max)
      // shift timezone
      from += new Date(from).getTimezoneOffset() * 60 * 1000
      to += new Date(to).getTimezoneOffset() * 60 * 1000
      var fromAsDate = new Date(from)
      fromAsDate.setHours(0,0,0,0)
      if ($('#dateFilter').datepicker('getDate').getTime() == fromAsDate.getTime()) {
        // dateFilter hasn't changed
        getTraceDurations(from, to)
      } else {
        // dateFilter has changed
        plotFullDate($('#dateFilter').datepicker('getDate'))
      }
    }
    function getTraceDurations(from, to) {
      var queryString = 'from=' + from + '&to=' + to
      var durationLow = $('#durationLow').val() * 1000
      if (durationLow) {
        queryString += '&low=' + durationLow
      }
      var durationHigh = $('#durationHigh').val() * 1000
      if (durationHigh) {
        queryString += '&high=' + durationHigh
      }
      var usernameComparator = $('#usernameComparator').val()
      var username = $('#username').val()
      if (username) {
        queryString += '&usernameComparator=' + usernameComparator
        queryString += '&username=' + username
      }
      $.getJSON('/trace/durations?' + queryString, function(response) {
        var storedTraceDurations = response.storedTraceDurations
        activeTraceDurations = response.activeTraceDurations
        // shift for timezone
        for (var i = 0; i < storedTraceDurations.length; i++) {
          storedTraceDurations[i][0] -= new Date(storedTraceDurations[i][0]).getTimezoneOffset()
              * 60 * 1000
        }
        for (var i = 0; i < activeTraceDurations.length; i++) {
          activeTraceDurations[i][0] -= new Date(activeTraceDurations[i][0]).getTimezoneOffset()
              * 60 * 1000
        }
        plotResponseData(storedTraceDurations, activeTraceDurations, from, to)
      })
      $('#traces').html('')
    }
    function getTraceDetails() {
      var from, to, low, high
      var extraIds = []
      if (selection) {
        from = selection.xaxis.from
        to = selection.xaxis.to
        // low, high are expected in milliseconds
        low = selection.yaxis.from * 1000
        high = selection.yaxis.to * 1000
        // add live traces inside the selection
        for (var i = 0; i < activeTraceDurations.length; i++) {
          if (activeTraceDurations[i][0] >= selection.xaxis.from
              && activeTraceDurations[i][0] <= selection.xaxis.to
              && activeTraceDurations[i][1] >= selection.yaxis.from
              && activeTraceDurations[i][1] <= selection.yaxis.to) {
            extraIds.push(activeTraceDurations[i][2])
          }
        }
      } else {
        var axes = plot.getAxes()
        from = axes.xaxis.min
        to = axes.xaxis.max
        // low, high are expected in milliseconds
        low = axes.yaxis.min * 1000
        high = axes.yaxis.max * 1000
        // add live traces inside the current view
        for (var i = 0; i < activeTraceDurations.length; i++) {
          if (activeTraceDurations[i][0] >= axes.xaxis.min
              && activeTraceDurations[i][0] <= axes.xaxis.max
              && activeTraceDurations[i][1] >= axes.yaxis.min
              && activeTraceDurations[i][1] <= axes.yaxis.max) {
            extraIds.push(activeTraceDurations[i][2])
          }
        }
      }
      // shift timezone
      from += new Date(from).getTimezoneOffset() * 60 * 1000
      to += new Date(to).getTimezoneOffset() * 60 * 1000
      var query = 'from=' + Math.floor(from) + '&to=' + Math.ceil(to) + '&low=' + low + '&high='
        + high
      if (extraIds) {
        query += "&extra_ids=" + extraIds
      }
      $.getJSON('/trace/details?' + query, function(response) {
        traces = response
        $('#traces').html('')
        if (traces.length) {
          html = tracesTemplate(traces)
          $(html).appendTo('#traces')
        } else {
          $('#traces').html('no data')
        }
      })
    }
    var today = new Date()
    today.setHours(0,0,0,0)
    $('#dateFilter').datepicker({})
    $('#dateFilter').datepicker('setDate', today)
    $('#durationComparator').change(function() {
      if ($('#durationComparator').val() == 'greater') {
        $('#durationLowDiv').show()
        $('#durationAndDiv').hide()
        $('#durationHighDiv').hide()
        $('#durationHigh').val('')
      } else if ($('#durationComparator').val() == 'less') {
        $('#durationLowDiv').hide()
        $('#durationLow').val('')
        $('#durationAndDiv').hide()
        $('#durationHighDiv').show()
      } else if ($('#durationComparator').val() == 'between') {
        $('#durationLowDiv').show()
        $('#durationAndDiv').show()
        $('#durationHighDiv').show()
      }
    })
    $('#showDetails').click(function() {
      getTraceDetails()
    })
    $('#refreshButton').click(function() {
      refresh()
    })
    plotFullDate(today)
  })
</script>
</head>
<body>
  <h1 class="header">
    <a class="header-logo" href="/">Informant</a><span class="header-page-name">Traces</span>
    <span class="header-see-also">see also: <a href="configuration.html">Configuration</a></span>
  </h1>
  <form class="form-horizontal">
    <fieldset>
      <legend>Filters</legend>
      <div class="control-group">
        <label class="control-label" for="dateFilter">Date</label>
        <div class="controls">
          <input type="text" class="input-small" id="dateFilter">
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="timeFilter">Time</label>
        <div class="controls">
          <!-- TODO maybe bootstrap issue that padding-top is required for vertical alignment? -->
          <span id="timeFilter" class="help-inline" style="padding-top: 5px">All day</span>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="durationBounds">Duration</label>
        <div class="controls">
          <select class="input-medium0" id="durationComparator">
            <option value="greater">Greater than</option>
            <option value="less">Less than</option>
            <option value="between">Between</option>
          </select>
          <div id="durationLowDiv" class="input-append">
            <input id="durationLow" class="input-small"
              type="text"><span class="add-on">seconds</span>
          </div>
          <div id="durationAndDiv" class="input-append" style="display: none">and</div>
          <div id="durationHighDiv" class="input-append" style="display: none">
            <input id="durationHigh" class="input-small"
              type="text"><span class="add-on">seconds</span>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="username">Username</label>
        <div class="controls">
          <select class="input-medium0" id="usernameComparator">
            <option value="begins">Begins with</option>
            <option value="equals">Equals</option>
            <option value="contains">Contains</option>
          </select>
          <input type="text" class="input-small" id="username">
        </div>
      </div>
      <div class="control-group">
        <div class="controls">
          <button id="refreshButton" type="button" class="btn">Refresh</button>
        </div>
      </div>
    </fieldset>
  </form>
  <br>
  <div>
    <div id="placeholder" style="height: 300px"></div>
  </div>
  <br>
  <button class="btn" id="showDetails">Show Details</button>
  <br>
  <br>
  <div id="traces"></div>
  <div id="stacktracemodal" class="modal hide fade"
    style="width: 800px; margin: -300px 0 0 -400px; max-height: 600px">
    <div class="modal-header">
      <a class="close" data-dismiss="modal">×</a>
      <h3>Stack Trace</h3>
    </div>
    <div id="stacktrace" class="modal-body"></div>
    <div class="modal-footer">
      <a href="#" class="btn">Close</a>
    </div>
  </div>
</body>
</html>
