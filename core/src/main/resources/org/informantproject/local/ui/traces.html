<!doctype html>
<!--
  Copyright 2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Informant | Trace explorer</title>
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="libs/bootstrap/2.0.4/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="libs/bootstrap-datepicker/0.1-nightly-20120709/css/datepicker.css"
    type="text/css" />
<link rel="stylesheet" href="libs/qtip/2.0.0-nightly-20120519/jquery.qtip.min.css"
    type="text/css" />
<link rel="stylesheet" href="css/informant.css" type="text/css" />
<style type="text/css">
  /* always display vertical scrollbar so content doesn't resize when showing long trace detail */
  html {
    overflow: -moz-scrollbars-vertical;
    overflow-y: scroll;
  }
</style>
<script type="text/javascript" src="libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="libs/bootstrap/2.0.4/js/bootstrap.min.js"></script>
<script type="text/javascript"
    src="libs/bootstrap-datepicker/0.1-nightly-20120709/js/bootstrap-datepicker.js">
</script>
<script type="text/javascript" src="libs/moment/1.6.2/moment.min.js"></script>
<script type="text/javascript" src="libs/handlebars/1.0.0.beta.6/handlebars.js"></script>
<!--[if lte IE 8]>
<script type="text/javascript" src="libs/flot/0.7-1/excanvas.min.js"></script>
<![endif]-->
<script type="text/javascript" src="libs/flot/0.7-1/jquery.flot.min.js"></script>
<script type="text/javascript" src="libs/flot/0.7-1/jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="libs/flot/0.7-1/jquery.flot.navigate.min.js"></script>
<script type="text/javascript" src="libs/flot/0.7-1/jquery.flot.resize.min.js"></script>
<script type="text/javascript" src="libs/spin/1.2.5/spin.min.js"></script>
<script type="text/javascript" src="libs/qtip/2.0.0-nightly-20120519/jquery.qtip.min.js"></script>
<script type="text/javascript" src="js/traces.js"></script>
<script type="text/javascript" src="js/informant.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    var plot, snapshotPoints, activePoints, currentItem, prospectiveItem, tooltipShowing

    var options = {
      legend: { show: false },
      series: {
        points: { show: true }
      },
      grid: { hoverable: true, clickable: true },
      xaxis: { mode: 'time' },
      yaxis: { ticks: 10, zoomRange : false },
      zoom: { interactive: true, amount : 1.5 },
    }
    function plotResponseData(snapshotPoints, activePoints, from, to) {
      var fromAsDate = new Date(from)
      fromAsDate.setHours(0,0,0,0)
      var zoomRangeFrom = fromAsDate.getTime()
      var zoomRangeTo = zoomRangeFrom + 24 * 60 * 60 * 1000; // zoomRangeFrom + 24 hours
      from -= new Date(from).getTimezoneOffset() * 60 * 1000
      to -= new Date(to).getTimezoneOffset() * 60 * 1000
      zoomRangeFrom -= new Date(zoomRangeFrom).getTimezoneOffset() * 60 * 1000
      zoomRangeTo -= new Date(zoomRangeTo).getTimezoneOffset() * 60 * 1000
      overrideOptions = {
        xaxis: { min : from, max : to, zoomRange : [ zoomRangeFrom, zoomRangeTo ] }
      }
      plot = $.plot($('#placeholder'), [snapshotPoints, activePoints],
          $.extend(true, {}, options, overrideOptions))
      updateTimeFilter()
    }
    function itemsEqual(plotItem1, plotItem2) {
      if (!plotItem1 && !plotItem2) {
        return true
      } else if (!plotItem1) {
        return false
      } else if (!plotItem2) {
        return false
      } else {
        return plotItem1.seriesIndex == plotItem2.seriesIndex && plotItem1.dataIndex
            == plotItem2.dataIndex
      }
    }
    function hideTooltip() {
      hideSpinner('#tooltipSpinner')
      $('#placeholder').qtip('hide')
      tooltipShowing = false
    }
    $('#placeholder').bind('plotzoom', function (event, plot) {
      // cancel any refresh in action
      if (refreshQueryString) {
        refreshQueryString = undefined
        hideSpinner('#refreshButtonSpinner')
        showAndFadeSuccessMessage('#refreshButtonCancelByZoom')
      }
      updateTimeFilter()
      if (currentItem) {
        // highlight gets out of sync on zoom
        plot.unhighlight()
        plot.highlight(currentItem.seriesIndex, currentItem.dataIndex)
        // leave the highlight, but cancel the tooltip since it is out of sync also, the user can
        // get tooltip again by hovering over the highlighted data point
        hideTooltip()
      }
    })
    $('#placeholder').click(function() {
      hideTooltip()
    })
    $(document).keyup(function(e) {
      if (e.keyCode == 27 && currentItem) { // esc key
        hideTooltip()
      }
    })
    $('#placeholder').bind('plothover', function (event, pos, item) {
      if (item && itemsEqual(item, currentItem) && !tooltipShowing) {
        // this happens after a zoom when the data point is still highlighted but the tooltip has
        // been hidden, and then the user hovers back over the same highlighted data point
        // in this case just show the tooltip immediately
        tooltipShowing = true
        showTraceDetailTooltip(item)
      } else if (item && !itemsEqual(item, currentItem)) {
        if (itemsEqual(item, prospectiveItem)) {
          // another handler is already waiting and will display the tooltip after the timeout below
          return
        }
        prospectiveItem = item
        // hover must last at least 100 milliseconds to prevent accidental hovers and unnecessary
        // server requests
        setTimeout(function() {
          if (!itemsEqual(item, prospectiveItem)) {
            // user moved on before 100 milliseconds, cancel the tooltip
            return
          }
          currentItem = item
          plot.unhighlight()
          $('#placeholder').qtip('hide')
          plot.highlight(item.series, item.datapoint)
          tooltipShowing = true
          showTraceDetailTooltip(item)
        }, 100)
      } else {
        prospectiveItem = null
      }
    })
    function updateTimeFilter() {
      var from = Math.floor(plot.getAxes().xaxis.min)
      var to = Math.ceil(plot.getAxes().xaxis.max)
      // shift timezone
      from += new Date(from).getTimezoneOffset() * 60 * 1000
      to += new Date(to).getTimezoneOffset() * 60 * 1000
      // TODO use localized time format
      // currently momentjs provides only 'LT' for localized time but this does not include seconds
      // see http://momentjs.com/docs/#/customization/long-date-formats
      $('#timeFilter').html(moment(from).format('h:mm:ss A') + ' &nbsp; to &nbsp; '
          + moment(to).format('h:mm:ss A (Z)'))
    }
    function refresh() {
      // TODO use localized date format, see more detailed comment at datepicker construction since
      // the format needs to be sync'd between the date picker and this parsing
      var date = moment($('#dateFilter').val(), 'MM/DD/YYYY')
      var from
      var to
      if (plot) {
        from = moment(Math.floor(plot.getAxes().xaxis.min))
        to = moment(Math.ceil(plot.getAxes().xaxis.max))
        // shift timezone
        from.add('minutes', from.zone())
        to.add('minutes', to.zone())
        var fromAsDate = from.clone()
        fromAsDate.hours(0)
        fromAsDate.minutes(0)
        fromAsDate.seconds(0)
        fromAsDate.milliseconds(0)
        if (date.valueOf() == fromAsDate.valueOf()) {
          // dateFilter hasn't changed
          from = from.valueOf()
          to = to.valueOf()
        } else {
          // dateFilter has changed
          from = date.valueOf()
          to = date.valueOf() + 24 * 60 * 60 * 1000
        }
      } else {
        // plot.getAxes() is not yet available because the refresh button was hit refresh during
        // (a possibly very long) initial load and
        from = date.valueOf()
        to = date.valueOf() + 24 * 60 * 60 * 1000
      }
      var queryString = buildQueryString()
      getTracePoints(from, to, queryString, false)
    }
    function buildQueryString() {
      var queryString = ''
      var durationLow = $('#durationLow').val() * 1000
      if (durationLow) {
        queryString += '&low=' + durationLow
      }
      var durationHigh = $('#durationHigh').val() * 1000
      if (durationHigh) {
        queryString += '&high=' + durationHigh
      }
      var usernameComparator = $('#usernameComparator').val()
      var username = $('#usernameFilter').val()
      if (username) {
        queryString += '&usernameComparator=' + usernameComparator
        queryString += '&username=' + username
      }
      var error = $('#errorFilter').is(':checked')
      if (error) {
        queryString += '&error=true'
      }
      var fine = $('#fineFilter').is(':checked')
      if (fine) {
        queryString += '&fine=true'
      }
      return queryString
    }
    var refreshQueryString
    function getTracePoints(from, to, queryString, initialLoad) {
      queryString = 'from=' + from + '&to=' + to + queryString
      // handling crazy user clicking on the button
      if (!initialLoad && queryString == refreshQueryString) return
      var prevRefreshQueryString = refreshQueryString
      if (!initialLoad) {
        refreshQueryString = queryString
      }
      $.getJSON('trace/points?' + queryString, function(response) {
        if (initialLoad && refreshQueryString) {
          // a refresh query has been posted since this initial load
          return
        } else if (!initialLoad && refreshQueryString != queryString) {
          // a different query string has been posted since this one
          // or the refresh was 'canceled' by a zoom action
          return
        }
        refreshQueryString = undefined
        if (initialLoad) {
          hideSpinner('#initialLoadSpinner')
        } else {
          hideSpinner('#refreshButtonSpinner')
        }
        snapshotPoints = response.snapshotPoints
        activePoints = response.activePoints
        hideTooltip()
        currentItem = null
        $('#detailTab').html('')
        // shift for timezone
        for (var i = 0; i < snapshotPoints.length; i++) {
          snapshotPoints[i][0] -= new Date(snapshotPoints[i][0]).getTimezoneOffset() * 60 * 1000
        }
        for (var i = 0; i < activePoints.length; i++) {
          activePoints[i][0] -= new Date(activePoints[i][0]).getTimezoneOffset() * 60 * 1000
        }
        plotResponseData(snapshotPoints, activePoints, from, to)
      })
      if (initialLoad) {
        showSpinner('#initialLoadSpinner')
      } else {
        // hide initialLoadSpinner just in case the refresh button was hit during (a very long)
        // initial load
        hideSpinner('#initialLoadSpinner')
        if (!prevRefreshQueryString) {
          showSpinner('#refreshButtonSpinner')
        }
      }
    }
    function showTraceDetailTooltip(item) {
      var x = item.pageX
      var y = item.pageY
      var id
      if (item.seriesIndex == 0) {
        id = snapshotPoints[item.dataIndex][2]
      } else {
        id = activePoints[item.dataIndex][2]
      }
      var spinner = new Spinner({ lines: 10, width: 3, radius: 6, top: 2, left: 2 })
      function displaySpinner() {
        if (spinner) {
          var html = '<div id="tooltipSpinner" style="display: inline-block; width: 35px;'
            + ' height: 31px"></div>'
          $('#placeholder').qtip({
            content: {
              text: html
            },
            position: {
              target: [ x , y + 5 ],
              viewport: $('#placeholder')
            }
          })
          $('#placeholder').qtip('show')
          spinner.spin($('#tooltipSpinner').get(0))
        }
      }
      // small delay so that if there is an immediate response the spinner doesn't blink
      setTimeout(displaySpinner, 100)
      var currentItemForJson = currentItem
      $.getJSON('trace/summary/' + id, function(response) {
        spinner.stop()
        spinner = null
        if (!itemsEqual(currentItem, currentItemForJson)) {
          // too slow, the user has moved on to another point already
          return
        }
        summaryTrace = response
        var html = traceSummaryTemplate(summaryTrace)
        var showDetailHtml = '<br><div style="color: #b12930" id="showDetailOuter">'
            + '<a id="showDetail" href="#">show detail</a></div>'
        $('#placeholder').qtip({
          content: {
            text: html + showDetailHtml
          },
          position: {
            my: 'bottom center',
            target: [ x , y + 5 ],
            viewport: $('#tooltipboundary')
          },
          hide: {
            event: false
          },
          show: {
            event: false
          }
        })
        $('#placeholder').qtip('show')
        $('#showDetail').click(function() {
          $.getJSON('trace/detail/' + id, function(response) {
            detailTrace = response
            var html = traceSummaryTemplate(detailTrace)
            var detailHtml = traceDetailTemplate(detailTrace)
            hideTooltip()
            $('#detailTab').html(html + detailHtml)
            $('a[href="#detailTab"]').tab('show')
            $('#showDetailOuter').css('font-style', 'italic')
            $('#showDetailOuter').html('see detail tab below')
          })
          return false
        })
      })
    }
    var today = new Date()
    today.setHours(0,0,0,0)
    // TODO use bootstrap-datepicker momentjs backend when it's available and then use momentjs's
    // localized format 'moment.longDateFormat.L' both here and when parsing date
    // see https://github.com/eternicode/bootstrap-datepicker/issues/24
    $('#dateFilter').val(moment(today).format('MM/DD/YYYY'))
    $('#dateFilter').datepicker({format: 'mm/dd/yyyy', autoclose: true})
    $('#durationComparator').change(function() {
      if ($('#durationComparator').val() == 'greater') {
        $('#durationLowDiv').show()
        $('#durationAndDiv').hide()
        $('#durationHighDiv').hide()
        $('#durationHigh').val('')
      } else if ($('#durationComparator').val() == 'less') {
        $('#durationLowDiv').hide()
        $('#durationLow').val('')
        $('#durationAndDiv').hide()
        $('#durationHighDiv').show()
      } else if ($('#durationComparator').val() == 'between') {
        $('#durationLowDiv').show()
        $('#durationAndDiv').show()
        $('#durationHighDiv').show()
      }
    })
    $('#refreshButton').click(function() {
      refresh()
    })
    $('#zoomOut').click(function() {
      plot.zoomOut()
      return false
    })
    getTracePoints(today.getTime(), today.getTime() + 24 * 60 * 60 * 1000, '', true)
  })
</script>
</head>
<body>
  <h1 class="header">
    <a class="header-logo" href=".">
      <!-- lack of spaces on this line is important -->
      Informant</a><span class="header-page-name">Trace explorer
      </span>
    <span class="header-see-also">see also: <a href="configuration.html">configuration</a></span>
  </h1>
  <br>
  <div id="tooltipboundary" style="display: none; width: 100%; height: 10000px"></div>
  <div>
    <div id="placeholder" style="height: 300px">
      <div id="initialLoadSpinner" class="button-spinner"
          style="width: 100%; height: 100%; margin: 0px auto"></div>
    </div>
    <div style="width: 100%; text-align: center; font-style: italic">
      use mouse scroll wheel to zoom in and out
      (or double click to zoom in and use this link to <a href="#" id="zoomOut">zoom out</a>)
    </div>
  </div>
  <br>
  <br>
  <ul id="tab" class="nav nav-tabs">
    <li class="active"><a href="#filterTab" data-toggle="tab">Filter</a></li>
    <li><a id="yak" href="#detailTab" data-toggle="tab">Detail</a></li>
  </ul>
  <div id="tabContent" class="tab-content">
    <div class="tab-pane fade in active" id="filterTab">
      <form class="form-horizontal">
        <fieldset>
          <div class="control-group">
            <label class="control-label" for="dateFilter">Date</label>
            <div class="controls">
              <input type="text" class="input-small" id="dateFilter">
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="timeFilter">Time</label>
            <div class="controls">
              <!-- maybe bootstrap issue that padding-top is required for vertical alignment? -->
              <span id="timeFilter" class="help-inline" style="padding-top: 5px">All day</span>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="durationBounds">Duration</label>
            <div class="controls">
              <select class="input-medium0" id="durationComparator">
                <option value="greater">Greater than</option>
                <option value="less">Less than</option>
                <option value="between">Between</option>
              </select>
              <div id="durationLowDiv" class="input-append">
                <input id="durationLow" class="input-small"
                  type="text"><span class="add-on">seconds</span>
              </div>
              <div id="durationAndDiv" class="input-append" style="display: none">and</div>
              <div id="durationHighDiv" class="input-append" style="display: none">
                <input id="durationHigh" class="input-small"
                  type="text"><span class="add-on">seconds</span>
              </div>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="username">Username</label>
            <div class="controls">
              <select class="input-medium0" id="usernameComparator">
                <option value="begins">Begins with</option>
                <option value="equals">Equals</option>
                <option value="contains">Contains</option>
              </select>
              <input type="text" class="input-small" id="usernameFilter">
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="errorFilter">Error</label>
            <div class="controls">
              <input type="checkbox" class="input-small" id="errorFilter">
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="fineFilter">Fine-grained profile</label>
            <div class="controls">
              <input type="checkbox" class="input-small" id="fineFilter">
            </div>
          </div>
          <div class="control-group">
            <div class="controls">
              <button id="refreshButton" type="button" class="btn">Refresh</button>
              <div id="refreshButtonSpinner" class="button-spinner"></div>
              <span id="refreshButtonCancelByZoom" class="button-success-message"
                  style="color: red">
                Refresh canceled by zoom action
              </span>
            </div>
          </div>
        </fieldset>
      </form>
    </div>
    <div class="tab-pane fade" id="detailTab"></div>
  </div>
  <div id="stacktracemodal" class="modal hide fade"
    style="width: 800px; margin: -300px 0 0 -400px; max-height: 600px">
    <div class="modal-header">
      <a class="close" data-dismiss="modal">×</a>
      <h3>Stack Trace</h3>
    </div>
    <div id="stacktrace" class="modal-body"></div>
    <div class="modal-footer">
      <a href="#" class="btn">Close</a>
    </div>
  </div>
</body>
</html>
