<!--
  Copyright 2012-2013 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<div accordion class="accordion-outer">
  <div accordion-group heading="Trace Capture">
    <div accordion>
      <div accordion-group>
        <div accordion-heading>
          General
          <span ix-on-off
                ix-model="generalEnabled"
                ix-disabled="false">
          </span>
        </div>
        <form class="form-horizontal">
          <fieldset>
            <div class="accordion-form-padding">
              <div ix-control-group
                   ix-label="Enabled"
                   ix-model="config.generalConfig.enabled"
                   ix-type="checkbox">
              </div>
              <div ix-control-group
                   ix-label="Store threshold"
                   ix-model="config.generalConfig.storeThresholdMillis"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="milliseconds">
                <div class="help-block">
                  Any trace that exceeds this amount of time will be viewable immediately as
                  an active trace and will be stored to disk at its completion.
                </div>
              </div>
              <div ix-control-group
                   ix-label="Stuck threshold"
                   ix-model="config.generalConfig.stuckThresholdSeconds"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="seconds">
                <div class="help-block">
                  Any trace that exceeds this amount of time will be stored to disk
                  immediately (prior to its completion).
                  This is to guard against threads which get stuck forever (or at least long
                  enough and do enough harm to the jvm that it has to be restarted).
                </div>
              </div>
              <div ix-control-group
                   ix-label="Max spans"
                   ix-model="config.generalConfig.maxSpans"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em">
                <div class="help-block">
                  Maximum number of spans collected for a given trace. This is useful for
                  limiting the memory requirement of very very long traces that capture
                  potentially hundreds of thousands of spans (e.g. large batch or background
                  operations).
                  Also, the ui is not really optimized for viewing super large numbers of
                  spans.
                </div>
              </div>
            </div>
            <div class="form-actions">
              <div ix-button
                   ix-label="Save changes"
                   ix-click="saveGeneralConfig(deferred)">
              </div>
            </div>
          </fieldset>
        </form>
      </div>
      <div accordion-group>
        <div accordion-heading>
          Coarse-Grained Profiling
          <span ix-on-off
                ix-model="coarseEnabled"
                ix-disabled="!generalEnabled">
          </span>
        </div>
        <form class="form-horizontal">
          <fieldset>
            <div class="accordion-form-padding">
              <div ix-control-group
                   ix-type="checkbox"
                   ix-label="Enabled"
                   ix-model="config.coarseProfilingConfig.enabled">
              </div>
              <div ix-control-group
                   ix-label="Initial delay"
                   ix-model="config.coarseProfilingConfig.initialDelayMillis"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="milliseconds">
                <div class="help-block">
                  Once a trace exceeds this amount of time, the coarse-grained profiler
                  captures stack traces periodically.
                  The interval between successive stack trace captures is defined by the
                  property directly below.
                  The stack traces captured for an individual trace are merged into a tree
                  view and provide a profile of the time spent in various portions of the
                  code.
                </div>
              </div>
              <div ix-control-group
                   ix-label="Interval"
                   ix-model="config.coarseProfilingConfig.intervalMillis"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="milliseconds">
                <div class="help-block">
                  The interval at which the coarse-grained profiler captures stack traces
                  (once a trace exceeds the initial delay directly above).
                </div>
              </div>
              <div ix-control-group
                   ix-label="Total"
                   ix-model="config.coarseProfilingConfig.totalSeconds"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="seconds">
                <div class="help-block">
                  The total length of time that the coarse-grained profiler captures stack
                  traces (once a trace exceeds the initial delay above).
                </div>
              </div>
            </div>
            <div class="form-actions">
              <div ix-button
                   ix-label="Save changes"
                   ix-click="saveCoarseProfilingConfig(deferred)">
              </div>
            </div>
          </fieldset>
        </form>
      </div>
      <div accordion-group>
        <div accordion-heading>
          Fine-Grained Profiling
          <span ix-on-off
                ix-model="fineEnabled"
                ix-disabled="!generalEnabled">
          </span>
        </div>
        <form class="form-horizontal" name="fineForm">
          <fieldset>
            <div class="accordion-form-padding">
              <div ix-control-group
                   ix-label="Enabled"
                   ix-model="config.fineProfilingConfig.enabled"
                   ix-type="checkbox">
              </div>
              <div ix-control-group
                   ix-label="Trace percentage"
                   ix-model="config.fineProfilingConfig.tracePercentage"
                   ix-pattern="{{pattern.percentage}}"
                   ix-width="5em"
                   ix-add-on="%">
                <div class="help-block">
                  Apply fine-grained profiling to this percentage of traces.
                </div>
              </div>
              <div ix-control-group
                   ix-label="Interval"
                   ix-model="config.fineProfilingConfig.intervalMillis"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="milliseconds">
                <div class="help-block">
                  The interval at which the fine-grained profiler captures stack traces (there
                  is no initial delay for the fine-grained profiler).
                </div>
              </div>
              <div ix-control-group
                   ix-label="Total"
                   ix-model="config.fineProfilingConfig.totalSeconds"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="seconds">
                <div class="help-block">
                  The total length of time that the fine-grained profiler captures stack traces.
                </div>
              </div>
              <div class="ix-control-group"
                   ng-class="{error: !fineForm.fineStoreThresholdMillis.$valid}">
                <label class="ix-label" for="fineStoreThresholdMillis">
                  Store threshold
                </label>
                <div class="controls">
                  <div style="padding-top: 5px; padding-bottom: 5px;">
                    <label class="checkbox">
                      <input type="checkbox" ng-model="data.fineStoreThresholdOverride"
                             id="fineStoreThresholdOverride">
                      Override general store threshold
                    </label>
                  </div>
                  <div class="input-append">
                    <input type="text"
                           ng-model="data.fineStoreThresholdMillis"
                           ng-pattern="{{pattern.integer}}"
                           id="fineStoreThresholdMillis"
                           name="fineStoreThresholdMillis"
                           style="width: 5em;"
                           ng-readonly="!data.fineStoreThresholdOverride"
                           ng-required="data.fineStoreThresholdOverride">
                    <span class="add-on">milliseconds</span>
                  </div>
                  <div class="help-block">
                    After going through the trouble of collecting fine-grained profiling info,
                    it may be worth while to store the given trace even if it doesn't hit the
                    general store threshold.
                  </div>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <div ix-button
                   ix-label="Save changes"
                   ix-click="saveFineProfilingConfig(deferred)">
              </div>
            </div>
          </fieldset>
        </form>
      </div>
      <div accordion-group>
        <div accordion-heading>
          User-Specific Overrides
          <span ix-on-off
                ix-model="userEnabled"
                ix-disabled="!generalEnabled">
          </span>
        </div>
        <form class="form-horizontal">
          <fieldset>
            <div class="accordion-form-padding">
              <div ix-control-group
                   ix-label="Enabled"
                   ix-model="config.userOverridesConfig.enabled"
                   ix-type="checkbox">
              </div>
              <div ix-control-group
                   ix-label="User ID"
                   ix-model="config.userOverridesConfig.userId"
                   ix-width="10em">
                <div class="help-block">
                  All traces for the given user will use the store threshold and profiling
                  configuration below.
                </div>
              </div>
              <div ix-control-group
                   ix-label="Store threshold"
                   ix-model="config.userOverridesConfig.storeThresholdMillis"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="milliseconds">
                <div class="help-block">
                  All traces for the given user that exceeds this amount of time will be
                  viewable immediately as an active trace and will be stored to disk at its
                  completion.
                </div>
              </div>
              <div ix-control-group
                   ix-label="Fine profiling"
                   ix-model="config.userOverridesConfig.fineProfiling"
                   ix-type="checkbox">
                <div class="help-block">
                  All traces for the given user will be profiled using the fine-grained
                  profiler.
                </div>
              </div>
            </div>
            <div class="form-actions">
              <div ix-button
                   ix-label="Save changes"
                   ix-click="saveuserOverridesConfig(deferred)">
              </div>
            </div>
          </fieldset>
        </form>
      </div>
      <div accordion-group heading="Storage">
        <form class="form-horizontal">
          <fieldset>
            <div class="accordion-form-padding">
              <div ix-control-group
                   ix-label="Keep trace snapshots for"
                   ix-model="data.snapshotExpirationDays"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="days">
                <div ix-button
                     ix-label="Delete All"
                     ix-click="deleteAll(deferred)"
                     class="inline-block"
                     style="margin-left: 20px;">
                </div>
                <div class="help-block" style="margin-top: 10px;">
                  Defines how long the trace snapshots should be retained in the H2 data file.
                  <em>Delete All</em> will clear all trace snapshots from the H2 data file.
                </div>
              </div>
              <div ix-control-group
                   ix-label="Rolling data file size"
                   ix-model="config.storageConfig.rollingSizeMb"
                   ix-pattern="{{pattern.integer}}"
                   ix-width="5em"
                   ix-add-on="MB">
                <div class="help-block">
                  Trace detail data (spans and profiling data) is stored to disk as
                  LZF-compressed json data in a rolling data file to efficiently cap the
                  growth of this large data.
                  (Trace summary data - grouping, capture time, duration, user ID, attributes,
                  metrics - is stored to an H2 data file by the embedded H2 database engine.)
                </div>
              </div>
              <div class="ix-control-group">
                <label class="ix-label">Data directory</label>
                <div class="controls">
                  <span class="uneditable-input" style="width: {{dataDirControlWidth}};">
                    {{config.dataDir}}
                  </span>
                  <div class="help-block">
                    The data directory where the H2 data file and the rolling database are
                    stored.
                    The default value is the directory where the informant.jar resides.
                    This can only be changed on the command line, using
                    <span class="nowrap">-Dinformant.data.dir=&lt;folder&gt;</span>.
                  </div>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <div ix-button
                   ix-label="Save changes"
                   ix-click="saveStorageConfig(deferred)">
              </div>
            </div>
          </fieldset>
        </form>
      </div>
    </div>
  </div>
  <div accordion-group heading="Plugins">
    <div accordion>
      <div accordion-group
           ng-repeat="plugin in plugins">
        <div accordion-heading>
          {{plugin.descriptor.name}}
          <span ix-on-off
                ix-model="plugin.enabled"
                ix-disabled="!generalEnabled">
          </span>
        </div>
        <form class="form-horizontal">
          <fieldset>
            <div class="accordion-form-padding">
              <div ix-control-group
                   ix-label="Enabled"
                   ix-model="plugin.config.enabled"
                   ix-type="checkbox">
              </div>
              <div ng-repeat="property in plugin.descriptor.properties">
                <div ng-switch on="property.type" ng-hide="property.hidden">
                  <div ng-switch-when="string"
                       ix-control-group
                       ix-label="{{property.prompt}}"
                       ix-model="property.value"
                       ix-width="25em">
                    <div class="help-block">
                      {{property.description}}
                    </div>
                  </div>
                  <div ng-switch-when="boolean"
                       ix-control-group
                       ix-label="{{property.prompt}}"
                       ix-model="property.value"
                       ix-type="checkbox">
                    <div class="help-block">
                      {{property.description}}
                    </div>
                  </div>
                  <div ng-switch-when="double"
                       ix-control-group
                       ix-label="{{property.prompt}}"
                       ix-model="property.value"
                       ix-pattern="{{pattern.double}}"
                       ix-width="5em">
                    <div class="help-block">
                      {{property.description}}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <div ix-button
                   ix-label="Save changes"
                   ix-click="savePluginConfig(deferred, $index)">
              </div>
            </div>
          </fieldset>
        </form>
      </div>
    </div>
  </div>
</div>
<span class="offscreen" id="offscreenMeasure"></span>
