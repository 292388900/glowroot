<!doctype html>
<!--
  Copyright 2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Informant | Configuration</title>
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="bootstrap/2.0.0/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="css/informant.css" type="text/css" />
<script type="text/javascript" src="jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="spin/1.2.3/spin.min.js"></script>
<script type="text/javascript">
  function read() {
    $.getJSON('/configuration/read', function(configuration) {
      var coreConfiguration = configuration.coreConfiguration
      $('#enabled').attr('checked', coreConfiguration.enabled)
      $('#thresholdMillis').val(coreConfiguration.thresholdMillis)
      $('#stuckThresholdMillis').val(coreConfiguration.stuckThresholdMillis)
      $('#stackTraceInitialDelayMillis').val(coreConfiguration.stackTraceInitialDelayMillis)
      $('#stackTracePeriodMillis').val(coreConfiguration.stackTracePeriodMillis)
      $('#spanStackTraceThresholdMillis').val(coreConfiguration.spanStackTraceThresholdMillis)
      $('#maxSpansPerTrace').val(coreConfiguration.maxSpansPerTrace)
      $('#rollingSizeMb').val(coreConfiguration.rollingSizeMb)
      if (configuration.actualRollingSizeMb != coreConfiguration.rollingSizeMb) {
        $('#actualRollingSizeMb').html(configuration.actualRollingSizeMb)
        $('#rollingSizeHelp').css('display', 'inline-block')
      }
    })
  }
  function showAndFadeSuccessMessage(selector) {
    $(selector).each(function() {
      // handling crazy user clicking on the button
      if ($(this).data('timeout')) {
        clearTimeout($(this).data('timeout'))
      }
      $(this).stop().animate({opacity:'100'})
      $(this).css('display','inline-block')
      var outerThis = this
      $(this).data('timeout', setTimeout(function() { $(outerThis).fadeOut(1000) }, 1000))
    })
  }
  function showSpinner(selector) {
    $(selector).each(function() {
      var data = $(this).data()
      data.spinner = new Spinner({ lines: 10, width: 4, radius: 8 })
      var outerThis = this
      function displaySpinner() {
        // data.spinner may have been cleared already by hideSpinner() before setTimeout triggered
        if (data.spinner) {
          $(outerThis).css('display','inline-block')
          data.spinner.spin(outerThis)
        }
      }
      // small delay so that if there is an immediate page return it doesn't blink
      setTimeout(displaySpinner, 100)
    })
  }
  function hideSpinner(selector) {
    $(selector).each(function() {
      var data = $(this).data()
      if (data.spinner) {
        data.spinner.stop()
        delete data.spinner
      }
      $(this).hide()
    })
  }
  function update() {
    var configuration = {
      'enabled': $('#enabled').is(':checked'),
      'thresholdMillis': $('#thresholdMillis').val(),
      'stuckThresholdMillis': $('#stuckThresholdMillis').val(),
      'stackTraceInitialDelayMillis': $('#stackTraceInitialDelayMillis').val(),
      'stackTracePeriodMillis': $('#stackTracePeriodMillis').val(),
      'spanStackTraceThresholdMillis': $('#spanStackTraceThresholdMillis').val(),
      'maxSpansPerTrace': $('#maxSpansPerTrace').val()
    }
    $.post('/configuration/update', JSON.stringify(configuration), function() {
      showAndFadeSuccessMessage('#saveComplete')
    })
  }
  var postingClearData = false
  function clearData() {
    // handling crazy user clicking on the button
    if (postingClearData) return
    postingClearData = true
    var keepMillis = $('input:radio[name=keepMillis]:checked').val()
    var compact = $('#compact').is(':checked')
    $.post('/admin/cleardata?keepMillis=' + keepMillis + '&compact=' + compact, function() {
      postingClearData = false
      hideSpinner('#clearButtonSpinner')
      showAndFadeSuccessMessage('#clearSuccessMessage')
    })
    // in case button is clicked again before success message is hidden
    $('#clearSuccessMessage').hide()
    showSpinner('#clearButtonSpinner')
  }
  var postingResize = false
  function resizeRollingDb() {
    // handling crazy user clicking on the button
    if (postingResize) return
    postingResize = true
    var newRollingSizeMb = $('#rollingSizeMb').val()
    $.post('/admin/resizerolling?newRollingSizeMb=' + newRollingSizeMb, function() {
      postingResize = false
      hideSpinner('#resizeButtonSpinner')
      showAndFadeSuccessMessage('#resizeSuccessMessage')
    })
    // in case button is clicked again before success message is hidden
    $('#resizeSuccessMessage').hide()
    showSpinner('#resizeButtonSpinner')
  }
  read()
</script>
</head>
<body>
  <h1 class="header">
    <a class="header-logo" href="/">Informant</a><span class="header-page-name">Configuration</span>
    <span class="header-see-also">see also: <a href="traces.html">Traces</a></span>
  </h1>
  <form class="form-horizontal">
    <fieldset>
      <legend>Thresholds and limits</legend>
      <div class="control-group">
        <label class="control-label" for="enabled">Enabled</label>
        <div class="controls">
          <input id="enabled" type="checkbox" value="true">
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="thresholdMillis">Threshold</label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="thresholdMillis" type="text">
            <span class="add-on">milliseconds</span>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="stuckThresholdMillis">Stuck threshold</label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="stuckThresholdMillis" type="text">
            <span class="add-on">milliseconds</span>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="stackTraceInitialDelayMillis">
          Stack trace initial delay
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="stackTraceInitialDelayMillis" type="text">
            <span class="add-on">milliseconds</span>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="stackTracePeriodMillis">Stack trace period</label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="stackTracePeriodMillis" type="text">
            <span class="add-on">milliseconds</span>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="spanStackTraceThresholdMillis">
          Span stack trace threshold
        </label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="spanStackTraceThresholdMillis" type="text">
            <span class="add-on">milliseconds</span>
          </div>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="maxSpansPerTrace">Max spans per trace</label>
        <div class="controls">
          <input style="width: 6em" id="maxSpansPerTrace" type="text">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="update()">Save changes</button>
        <div id="saveComplete" class="form-button-success">Saved</div>
      </div>
    </fieldset>
    <fieldset>
      <legend>
        Summary data
        <span style="padding-left: 15px; font-size: 15px; color:#999999">
          (metric data and high level trace data)
        </span>
      </legend>
      <div class="control-group">
        <label class="control-label" for="keepMillis">Keep</label>
        <div class="controls">
          <label class="radio">
            <input type="radio" name="keepMillis" value="2419200000" checked> Last 4 weeks
          </label>
          <label class="radio">
            <input type="radio" name="keepMillis" value="604800000"> Last 7 days
          </label>
          <label class="radio">
            <input type="radio" name="keepMillis" value="86400000"> Last 24 hours
          </label>
          <label class="radio">
            <input type="radio" name="keepMillis" value="3600000"> Last 60 minutes
          </label>
          <label class="radio">
            <input type="radio" name="keepMillis" value="0"> None
          </label>
        </div>
      </div>
      <div class="control-group">
        <label class="control-label" for="compact">Compact</label>
        <div class="controls">
          <input id="compact" type="checkbox" value="true">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="clearData()">Clear data</button>
        <div id="clearButtonSpinner" class="form-button-spinner"></div>
        <div id="clearSuccessMessage" class="form-button-success">Cleared</div>
      </div>
    </fieldset>
    <fieldset>
      <legend>
        Detail data
        <span style="padding-left: 15px; font-size: 15px; color:#999999">
          (low level trace data)
        </span>
      </legend>
      <div class="control-group">
        <label class="control-label" for="rollingSizeMb">Rolling database size</label>
        <div class="controls">
          <div class="input-append">
            <input style="width: 6em" id="rollingSizeMb" type="text">
            <span class="add-on">MB</span>
            <div id="rollingSizeHelp" class="help-block" style="display: none; margin-left: 1em">
              (actual rolling size <span id="actualRollingSizeMb"></span> MB)
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="resizeRollingDb()">Resize</button>
        <div id="resizeButtonSpinner" class="form-button-spinner"></div>
        <div id="resizeSuccessMessage" class="form-button-success">Cleared</div>
      </div>
    </fieldset>
  </form>
</body>
</html>
