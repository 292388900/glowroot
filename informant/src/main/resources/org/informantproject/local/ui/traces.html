<!doctype html>
<!--
  Copyright 2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Informant | Traces</title>
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="bootstrap/2.0.0/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="css/informant.css" type="text/css" />
<link rel="stylesheet" href="jqueryui/1.8.17/ui-lightness/jquery-ui.all.css" type="text/css" />
<script type="text/javascript" src="jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="jqueryui/1.8.17/jquery-ui.all.min.js"></script>
<script type="text/javascript" src="dateformat/1.2.3/date.format.js"></script>
<script type="text/javascript" src="handlebars/1.0.0.beta.6/handlebars.js"></script>
<script type="text/javascript" src="flot/0.7/jquery.flot.min.js"></script>
<script type="text/javascript" src="flot/0.7/jquery.flot.selection.min.js"></script>

<script id="tracesTemplate" type="text/x-handlebars-template">
{{#each .}}
<div>
  {{#if stuck}}<b>{{#if completed}}UN{{/if}}STUCK</b><br>{{/if}}
  start: {{date start}}<br>
  duration: {{nanosToMillis duration}} milliseconds<br>
  {{#if username}}username: {{username}}<br>{{/if}}
  threadName(s): {{threadNames}}<br>
  root context:<br>
  {{#first spans}}
    <div style="margin-left: 1em">{{#eachEntry contextMap}}{{/eachEntry}}</div>
  {{/first}}
  <a href="javascript:$('#sp_{{id}}').toggle()">spans</a> ({{spans.length}})<br>
  <div id="sp_{{id}}" style="display: none">
    {{#spans}}
      <div style="float: left; margin-left: 1em; width: 3em; text-align: right">
        +{{nanosToMillis offset}}
      </div>
      <div style="margin-left: {{margin level}}em">
        <div style="width: 3em; float: left; text-align: right">
          {{nanosToMillis duration}}&nbsp;
        </div>
        <div style="margin-left: 4em">
          {{#ifLongDescription description}}
            <span class="sp_{{../id}}_{{index}}">
              <a href="javascript:$('.sp_{{../id}}_{{index}}').toggle()" style="color: #333">
                {{#short description}}{{/short}}
              </a>
            </span>
            <span class="sp_{{../id}}_{{index}}" style="display: none">
              <a href="javascript:$('.sp_{{../id}}_{{index}}').toggle()">
                {{description}}
              </a>
            </span>
          {{^}}
            {{description}}
          {{/ifLongDescription}}
          {{#if index}}
            <!-- context map for index=0 is displayed in root context section above -->
            <div style="margin-left: 2em">{{#eachEntry contextMap}}{{/eachEntry}}</div>
          {{/if}}
        </div>
      </div>
    {{/spans}}
  </div>
  <div style="clear: both"></div>
    <a href="javascript:$('#mst_{{id}}').toggle()">merged stack trace</a><br>
    <div id="mst_{{id}}" style="display: none; white-space: nowrap">
      {{#mergedStackTrace mergedStackTreeRootNodes}}{{/mergedStackTrace}}
    </div>
  </div>
  <br>
</div>
{{/each}}
</script>
<script type="text/javascript">
  Handlebars.registerHelper('date', function(timestamp) {
    return new Date(timestamp).format('m/d/yy h:MM:ss.l TT (Z)')
  })
  Handlebars.registerHelper('nanosToMillis', function(nanos) {
    return (nanos / 1000000).toFixed(1)
  })
  Handlebars.registerHelper('first', function(array, options) {
    return options.fn(array[0])
  })
  Handlebars.registerHelper('eachEntry', function(map, block) {
    var ret = ''
    for (var prop in map) {
      ret = ret + prop + ': ' + JSON.stringify(map[prop]) + '<br>'
    }
    return ret
  })
  Handlebars.registerHelper('ifLongDescription', function(description, options) {
    if (description.length > 160) {
      return options.fn(this)
    } else {
      return options.inverse(this)
    }
  })
  Handlebars.registerHelper('margin', function(level) {
    return 5 + level
  })
  Handlebars.registerHelper('short', function(description) {
    if (description.length <= 160) {
      return description
    } else {
      return description.slice(0, 80)
        + " <span style='color: #b12930; font-weight: bold'>...</span> " + description.slice(-80)
    }
  })
  Handlebars.registerHelper('mergedStackTrace', function(rootNodes, block) {
    var totalSampleCount = 0
    for (var i = 0; i < rootNodes.length; i++) {
      totalSampleCount += rootNodes[i].sampleCount
    }
    function curr(childNodes, level, totalSampleCount) {
      var ret = ''
      // order child nodes by sampleCount (descending)
      childNodes.sort(function(a, b) { return b.sampleCount - a.sampleCount })
      for (var i = 0; i < childNodes.length; i++) {
        var childNode = childNodes[i]
        var stackTraceElement = childNode.stackTraceElement
        if (childNode.sampleCount < totalSampleCount) {
          level++
        }
        for (var j = 0; j < level; j++) {
          ret += '&nbsp;'
        }
        ret += '&nbsp;&nbsp;<span style="display: inline-block; width: 4em">'
        var samplePercentage = (childNode.sampleCount / totalSampleCount) * 100
        ret += samplePercentage.toFixed(1)
        ret += '%</span>'
        ret += stackTraceElement + '<br>'
        if (childNode.leafThreadState) {
          for (var j = 0; j < level; j++) {
            ret += '&nbsp;'
          }
          ret += '&nbsp;&nbsp;<span style="display: inline-block; width: 4em">'
          ret += samplePercentage.toFixed(1)
          ret += '%</span>'
          ret += '&nbsp;' + childNode.leafThreadState + '<br>'
        }
        if (childNode.childNodes) {
          ret += curr(childNode.childNodes, level, totalSampleCount)
        }
      }
      return ret
    }
    return curr(rootNodes, 0, totalSampleCount)
  })
  $(document).ready(function() {
    var template = Handlebars.compile($('#tracesTemplate').html())
    Handlebars.registerPartial('span', $('#span-partial').html())

    var options = {
      legend: { show: false },
      series: {
        lines: { show: true },
        points: { show: true }
      },
      xaxis: { mode: 'time' },
      yaxis: { ticks: 10 },
      selection: { mode: 'xy' }
    }
    var overviewOptions = {
      legend: { show: true, container: $('#overviewLegend') },
      series: {
        lines: { show: true, lineWidth: 1 },
        shadowSize: 0
      },
      xaxis: { mode: 'time', ticks: 1 },
      yaxis: { ticks: 3},
      grid: { color: '#999' },
      selection: { mode: 'xy' }
    }

    function plotFullDate(date) {
      var from = date.getTime()
      var to = from + 24 * 60 * 60 * 1000; // from + 24 hours
      getTraceSummaries(from, to)
    }

    function plotResponseData(data) {
      var plot = $.plot($('#placeholder'), [data], options)
      var overview = $.plot($('#overview'), [data], overviewOptions)
      // reset the show details button handler
      $('#showDetails').unbind('click')
      $('#showDetails').click(function() {
        var xticks = plot.getAxes().xaxis.ticks
        var yticks = plot.getAxes().yaxis.ticks
        var range = { 'xaxis' : { 'from' : xticks[0].v, 'to' : xticks[xticks.length - 1].v },
          'yaxis' : { 'from' : yticks[0].v, 'to' : yticks[yticks.length - 1].v }}
        getTraceDetails(range)
      })

      // now connect the two
      $('#placeholder').bind('plotselected', function (event, ranges) {
        // clamp the zooming to prevent eternal zoom
        // also round xaxis to nearest millisecond
        ranges.xaxis.from = Math.floor(ranges.xaxis.from)
        ranges.xaxis.to = Math.ceil(ranges.xaxis.to)
        if (ranges.yaxis.to - ranges.yaxis.from < 0.00001) {
          ranges.yaxis.to = ranges.yaxis.from + 0.00001
        }
        // do the zooming
        plot = $.plot($('#placeholder'), [data], $.extend(true, {}, options, {
          xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
          yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
        }))

        // don't fire event on the overview to prevent eternal loop
        overview.setSelection(ranges, true)
        // reset the show details button handler
        $('#showDetails').unbind('click')
        $('#showDetails').click(function() {
          getTraceDetails(ranges)
        })
      })
      $('#overview').bind('plotselected', function (event, ranges) {
        plot.setSelection(ranges)
      })
    }

    function getTraceSummaries(from, to) {
      $.getJSON('/trace/summaries?from=' + from + '&to=' + to, function(response) {
        // shift for timezone
        for (var i = 0; i < response.data.length; i++) {
          response.data[i][0] -= new Date(response.data[i][0]).getTimezoneOffset() * 60 * 1000
        }
        var range = { 'xaxis' : { 'from' : 0, 'to' : 0 }, 'yaxis' : { 'from' : 0, 'to' : 0 }}
        if (response.data.length > 0) {
          range.xaxis.from = response.data[0][0]
          range.xaxis.to = response.data[response.data.length - 1][0]
        }
        plotResponseData(response.data)
      })
      $('#traces').html('')
    }

    function getTraceDetails(ranges) {
      var from = ranges.xaxis.from + new Date(ranges.xaxis.from).getTimezoneOffset() * 60 * 1000
      var to = ranges.xaxis.to + new Date(ranges.xaxis.to).getTimezoneOffset() * 60 * 1000
      // low, high are expected in milliseconds
      var low = ranges.yaxis.from * 1000
      var high = ranges.yaxis.to * 1000
      var query = 'from=' + from + '&to=' + to + '&low=' + low + '&high=' + high
      $.getJSON('/trace/details?' + query, function(traces) {
        $('#traces').html('')
        if (traces.length) {
          var html = template(traces)
          $(html).appendTo('#traces')
        } else {
          $('#traces').html('no data')
        }
      })
    }

    $('#datePicker').datepicker({ onSelect : function(dateText, inst) {
      plotFullDate($(this).datepicker('getDate'))
    }})
    var d = new Date()
    d.setHours(0,0,0,0)
    $('#datePicker').datepicker('setDate', d)
    plotFullDate(d)
  })
</script>
</head>
<body>
  <h1 class="page-title"><a href="/">Informant</a> <span style="color: #333">| Traces</span></h1>
  <div>
    Date: <input style="width: 7em" type="text" id="datePicker">
  </div><br>
  <div style="float: left">
    <div id="placeholder" style="width: 600px; height: 200px"></div>
  </div>
  <div id="miniature" style="float: left; margin-left: 20px">
    <div id="overview" style="width: 300px; height: 100px"></div>
    <p id="overviewLegend" style="margin-left: 10px"></p>
  </div>
  <div style="clear: left"></div>
  <br>
  <button class="btn" id="showDetails">Show Details</button>
  <br>
  <br>
  <div id="traces"></div>
</body>
</html>
