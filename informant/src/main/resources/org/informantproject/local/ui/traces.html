<!doctype html>
<!--
  Copyright 2012 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Informant | Traces</title>
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="bootstrap/2.0.0/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="css/informant.css" type="text/css" />
<link rel="stylesheet" href="jqueryui/1.8.17/ui-lightness/jquery-ui.all.css" type="text/css" />
<script type="text/javascript" src="jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="bootstrap/2.0.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="jqueryui/1.8.17/jquery-ui.all.min.js"></script>
<script type="text/javascript" src="dateformat/1.2.3/date.format.js"></script>
<script type="text/javascript" src="handlebars/1.0.0.beta.6/handlebars.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="flot/0.7.1-informant-01/jquery.flot.navigate.min.js"></script>

<script id="tracesTemplate" type="text/x-handlebars-template">
{{#each_with_index .}}
<div>
  {{#if stuck}}<b>{{#if completed}}UN{{/if}}STUCK</b><br>{{/if}}
  start: {{date start}}<br>
  duration: {{nanosToMillis duration}} milliseconds<br>
  {{#if username}}username: {{username}}<br>{{/if}}
  threadName(s): {{threadNames}}<br>
  root context:<br>
  {{#first spans}}
    <div style="margin-left: 1em">{{#eachEntry contextMap}}{{/eachEntry}}</div>
  {{/first}}
  <a href="javascript:toggleSpan({{index}}, '{{id}}')">spans</a> ({{spans.length}})<br>
  <div id="sp_{{id}}" style="display: none"></div>
  <div style="clear: both"></div>
    <a href="javascript:toggleMergedStackTrace({{index}}, '{{id}}')">merged stack trace</a>
    ({{mergedStackTree.sampleCount}})<br>
    <div id="mst_{{id}}" style="display: none; white-space: nowrap"></div>
  </div>
  <br>
</div>
{{/each_with_index}}
</script>
<script id="spansTemplate" type="text/x-handlebars-template">
{{#spans}}
  <div style="float: left; margin-left: 1em; width: 3em; text-align: right">
    +{{nanosToMillis offset}}
  </div>
  <div style="margin-left: {{margin level}}em">
    <div style="width: 3em; float: left; text-align: right">
      {{nanosToMillis duration}}&nbsp;
    </div>
    <div style="margin-left: 4em">
      {{#ifLongDescription description}}
        <span class="sp_{{../id}}_{{index}}">
          <a href="javascript:$('.sp_{{../id}}_{{index}}').toggle()" style="color: #333">
            {{#short description}}{{/short}}
          </a>
        </span>
        <span class="sp_{{../id}}_{{index}}" style="display: none">
          <a href="javascript:$('.sp_{{../id}}_{{index}}').toggle()">
            {{description}}
          </a>
        </span>
      {{^}}
        {{description}}
      {{/ifLongDescription}}
      {{#if index}}
        <!-- context map for index=0 is displayed in root context section above -->
        <div style="margin-left: 2em">{{#eachEntry contextMap}}{{/eachEntry}}</div>
      {{/if}}
      {{#if stackTraceHash}}
        <a href="javascript: viewStackTrace('{{stackTraceHash}}')">view stack trace</a>
      {{/if}}
    </div>
  </div>
{{/spans}}
</script>
<script type="text/javascript">
  Handlebars.registerHelper('each_with_index', function(array, options) {
    var ret = ''
    for (var i = 0; i < array.length; i++) {
      var item = array[i]
      // stick index onto item
      item.index = i
      ret += options.fn(item)
    }
    return ret
  })
  Handlebars.registerHelper('date', function(timestamp) {
    return new Date(timestamp).format('m/d/yy h:MM:ss.l TT (Z)')
  })
  Handlebars.registerHelper('nanosToMillis', function(nanos) {
    return (nanos / 1000000).toFixed(1)
  })
  Handlebars.registerHelper('first', function(array, options) {
    return options.fn(array[0])
  })
  Handlebars.registerHelper('eachEntry', function(map, block) {
    var ret = ''
    for (var prop in map) {
      ret = ret + prop + ': ' + JSON.stringify(map[prop]) + '<br>'
    }
    return ret
  })
  Handlebars.registerHelper('ifLongDescription', function(description, options) {
    if (description.length > 160) {
      return options.fn(this)
    } else {
      return options.inverse(this)
    }
  })
  Handlebars.registerHelper('margin', function(level) {
    return 5 + level
  })
  Handlebars.registerHelper('short', function(description) {
    if (description.length <= 160) {
      return description
    } else {
      return description.slice(0, 80)
        + " <span style='color: #b12930; font-weight: bold'>...</span> " + description.slice(-80)
    }
  })
  $(document).ready(function() {
    var tracesTemplate = Handlebars.compile($('#tracesTemplate').html())
    var spansTemplate1 = Handlebars.compile($('#spansTemplate').html())

    var plot, selection, traceDetails

    var options = {
      legend: { show: false },
      series: {
        points: { show: true }
      },
      xaxis: { mode: 'time' },
      yaxis: { ticks: 10, zoomRange : false },
      zoom: { interactive: true, amount : 1.5 },
      selection: { mode: 'xy' }
    }
    function plotFullDate(date) {
      var from = date.getTime()
      var to = from + 24 * 60 * 60 * 1000; // from + 24 hours
      getTraceSummaries(from, to)
    }
    function plotResponseData(storedData, liveData) {
      var overrideOptions = {}
      if (storedData.length || liveData.length) {
        var xmin
        var xmax
        if (storedData.length) {
          xmin = storedData[0][0]
          xmax = storedData[storedData.length - 1][0]
        }
        if (liveData.length) {
          xmin = Math.min(xmin, liveData[0][0])
          xmax = Math.max(xmax, liveData[liveData.length - 1][0])
        }
        overrideOptions = {
          xaxis: { zoomRange : [ xmin, xmax ] }
        }
      }
      plot = $.plot($('#placeholder'), [storedData, liveData], $.extend(true, {}, options,
          overrideOptions))
      selection = null
    }
    $('#placeholder').bind("plotselected", function(event, ranges) {
      selection = ranges
    })
    $('#placeholder').bind("plotunselected", function(event, ranges) {
      selection = null
    })
    $('#placeholder').bind('plotzoom', function (event, plot) {
      if (selection)
        plot.setSelection(selection)
    })

    function getTraceSummaries(from, to) {
      $.getJSON('/trace/summaries?from=' + from + '&to=' + to, function(response) {
        var storedData = response.storedData
        liveData = response.liveData
        // shift for timezone
        for (var i = 0; i < storedData.length; i++) {
          storedData[i][0] -= new Date(storedData[i][0]).getTimezoneOffset() * 60 * 1000
        }
        for (var i = 0; i < liveData.length; i++) {
          liveData[i][0] -= new Date(liveData[i][0]).getTimezoneOffset() * 60 * 1000
        }
        plotResponseData(storedData, liveData)
      })
      $('#traces').html('')
    }

    function getTraceDetails() {
      var from, to, low, high
      var extraIds = []
      if (selection) {
        from = selection.xaxis.from + new Date(selection.xaxis.from).getTimezoneOffset() * 60 * 1000
        to = selection.xaxis.to + new Date(selection.xaxis.to).getTimezoneOffset() * 60 * 1000
        // low, high are expected in milliseconds
        low = selection.yaxis.from * 1000
        high = selection.yaxis.to * 1000
        // add live traces inside the selection
        for (var i = 0; i < liveData.length; i++) {
          if (liveData[i][0] >= selection.xaxis.from && liveData[i][0] <= selection.xaxis.to
              && liveData[i][1] >= selection.yaxis.from && liveData[i][1] <= selection.yaxis.to) {
            extraIds.push(liveData[i][2])
          }
        }
      } else {
        var axes = plot.getAxes()
        from = axes.xaxis.min + new Date(axes.xaxis.min).getTimezoneOffset() * 60 * 1000
        to = axes.xaxis.max + new Date(axes.xaxis.max).getTimezoneOffset() * 60 * 1000
        // low, high are expected in milliseconds
        low = axes.yaxis.min * 1000
        high = axes.yaxis.max * 1000
        // add live traces inside the current view
        for (var i = 0; i < liveData.length; i++) {
          if (liveData[i][0] >= axes.xaxis.min && liveData[i][0] <= axes.xaxis.max
              && liveData[i][1] >= axes.yaxis.min && liveData[i][1] <= axes.yaxis.max) {
            extraIds.push(liveData[i][2])
          }
        }
      }
      var query = 'from=' + Math.floor(from) + '&to=' + Math.ceil(to) + '&low=' + low + '&high='
        + high
      if (extraIds) {
        query += "&extra_ids=" + extraIds
      }
      $.getJSON('/trace/details?' + query, function(traces) {
        traceDetails = traces
        $('#traces').html('')
        if (traces.length) {
          var html = tracesTemplate(traces)
          $(html).appendTo('#traces')
        } else {
          $('#traces').html('no data')
        }
      })
    }

    window.toggleSpan = function(index, id) {
      if ($('#sp_' + id).is(':visible')) {
        $('#sp_' + id).hide()
      } else {
        if (! $('#sp_' + id).html()) {
          var html = spansTemplate1(traceDetails[index])
          $(html).appendTo('#sp_' + id)
        }
        $('#sp_' + id).show()
      }
    }
    window.toggleMergedStackTrace = function(index, id) {
      var rootNode = traceDetails[index].mergedStackTree
      function curr(node, level) {
        var ret = ''
        var stackTraceElement = node.stackTraceElement
        if (node.sampleCount < rootNode.sampleCount)
          level++
        for (var j = 0; j < level; j++) {
          ret += '&nbsp;'
        }
        ret += '&nbsp;&nbsp;<span style="display: inline-block; width: 4em">'
        var samplePercentage = (node.sampleCount / rootNode.sampleCount) * 100
        ret += samplePercentage.toFixed(1)
        ret += '%</span>'
        ret += stackTraceElement + '<br>'
        if (node.leafThreadState) {
          for (var j = 0; j < level; j++) {
            ret += '&nbsp;'
          }
          ret += '&nbsp;&nbsp;<span style="display: inline-block; width: 4em">'
          ret += samplePercentage.toFixed(1)
          ret += '%</span>'
          ret += '&nbsp;' + node.leafThreadState + '<br>'
        }
        if (node.childNodes) {
          var childNodes = node.childNodes
          // order child nodes by sampleCount (descending)
          childNodes.sort(function(a, b) { return b.sampleCount - a.sampleCount })
          for (var i = 0; i < childNodes.length; i++) {
            ret += curr(childNodes[i], level)
          }
        }
        return ret
      }
      if ($('#mst_' + id).is(':visible')) {
        $('#mst_' + id).hide()
      } else {
        if (! $('#mst_' + id).html()) {
          var html = curr(rootNode, 0)
          $(html).appendTo('#mst_' + id)
        }
        $('#mst_' + id).show()
      }
    }
    window.viewStackTrace = function(stackTraceHash) {
      $.getJSON('/stacktrace/read?hash=' + stackTraceHash, function(stackTraceElements) {
        $('#stacktrace').html('')
        for (var i = 0; i < stackTraceElements.length; i++) {
          $('#stacktrace').append(stackTraceElements[i] + '<br>')
        }
        $('#stacktracemodal').modal('show')
      })
    }

    $('#datePicker').datepicker({ onSelect : function(dateText, inst) {
      plotFullDate($(this).datepicker('getDate'))
    }})
    $('#showDetails').click(function() {
      getTraceDetails()
    })
    var d = new Date()
    d.setHours(0,0,0,0)
    $('#datePicker').datepicker('setDate', d)
    plotFullDate(d)
  })
</script>
</head>
<body>
  <h1 class="page-title"><a href="/">Informant</a> <span style="color: #333">| Traces</span></h1>
  <div>
    Date: <input style="width: 7em" type="text" id="datePicker">
  </div><br>
  <div>
    <div id="placeholder" style="width: 900px; height: 300px"></div>
  </div>
  <br>
  <button class="btn" id="showDetails">Show Details</button>
  <br>
  <br>
  <div id="traces"></div>
  <div id="stacktracemodal" class="modal hide fade"
    style="width: 800px; margin: -300px 0 0 -400px; max-height: 600px">
    <div class="modal-header">
      <a class="close" data-dismiss="modal">×</a>
      <h3>Stack Trace</h3>
    </div>
    <div id="stacktrace" class="modal-body"></div>
    <div class="modal-footer">
      <a href="#" class="btn">Close</a>
    </div>
  </div>
</body>
</html>
