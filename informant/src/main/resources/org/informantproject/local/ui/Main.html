<!doctype html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Test Page</title>
<!-- not using CDN hosted js files since the embedded ui is typically for monitoring
     an application on a local machine / local network so this should be faster -->
<link rel="stylesheet" href="css/themes/ui-lightness/jquery.ui.all.css">
<script type="text/javascript" src="js/jquery.1.6.2.min.js"></script>
<script type="text/javascript" src="js/jquery.ui.core.1.8.16.min.js"></script>
<script type="text/javascript" src="js/jquery.ui.datepicker.1.8.16.min.js"></script>
<script type="text/javascript" src="js/jquery.flot.0.7.min.js"></script>
<script type="text/javascript" src="js/jquery.flot.selection.0.7.min.js"></script>
<script type="text/javascript" src="js/date.time.1.2.3.js"></script>
<script type="text/javascript" src="js/handlebars.1.0.0.beta.3.js"></script>

<script type="text/javascript" src="js/dynatree.1.2.0.rc1/jquery.dynatree.min.js"></script>

<script id="mytemplate" type="text/x-handlebars-template">
<div class="entry">
<h1>{{title}}</h1>
<div class="body">
  {{body}}
</div>
</div>
</script>
<script id="trace" type="text/x-handlebars-template">
<div>
id: {{id}}<br>
start: {{date start}}<br>
stuck: {{#if stuck}}yes{{^}}no{{/if}}<br>
uniqueId: {{uniqueId}}<br>
duration: {{duration}}<br>
completed: {{#if completed}}yes{{^}}no{{/if}}<br>
username: {{username}}<br>
spans:<br>
</div>
</script>
<script id="span-partial" type="text/x-handlebars-template">
<br>
offset: {{offset}}<br>
duration: {{duration}}<br>
index: {{index}}<br>
parent index: {{parentIndex}}<br>
level: {{level}}<br>
description: {{description}}<br>
context map:<br>
{{> map}}
</script>
<script id="map-partial" type="text/x-handlebars-template">
{{#eachentry contextMap}}
  yaik
{{/eachentry}}
</script>
<script type="text/javascript">
  Handlebars.registerHelper('date', function(timestamp) {
    return new Date(timestamp).format("m/d/yy h:MM:ss.l TT (Z)")
  });
  Handlebars.registerHelper('eachentry', function(context, block) {
    var ret = "";
    for (var prop in context) {
      ret = ret + prop + ": " + JSON.stringify(context[prop]) + "<br>";
    }
    return ret;
  });
  $(function() {
    // setup plot
    function getData(x1, x2) {
      var d = [];
      for (var i = 0; i <= 100; ++i) {
        var x = x1 + i * (x2 - x1) / 100;
        d.push([x, Math.sin(x * Math.sin(x))]);
      }
 
      return [
        { label: "sin(x sin(x))", data: d }
      ];
    }
 
    var options = {
      legend: { show: false }, 
      series: {
        lines: { show: true },
        points: { show: true }
      },
      yaxis: { ticks: 10 },
      selection: { mode: "xy" }
    };
 
    var startData = getData(0, 3 * Math.PI);
    
    var plot = $.plot($("#placeholder"), startData, options);
 
    // setup overview
    var overview = $.plot($("#overview"), startData, {
      legend: { show: true, container: $("#overviewLegend") },
      series: {
        lines: { show: true, lineWidth: 1 },
        shadowSize: 0
      },
      xaxis: { ticks: 4 },
      yaxis: { ticks: 3, min: -2, max: 2 },
      grid: { color: "#999" },
      selection: { mode: "xy" }
    });
 
    // now connect the two

    $("#placeholder").bind("plotselected", function (event, ranges) {
      // clamp the zooming to prevent eternal zoom
      if (ranges.xaxis.to - ranges.xaxis.from < 0.00001)
        ranges.xaxis.to = ranges.xaxis.from + 0.00001;
      if (ranges.yaxis.to - ranges.yaxis.from < 0.00001)
        ranges.yaxis.to = ranges.yaxis.from + 0.00001;

      // do the zooming
      plot = $.plot($("#placeholder"), getData(ranges.xaxis.from, ranges.xaxis.to),
                    $.extend(true, {}, options, {
                        xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                        yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
                    }));

      // don't fire event on the overview to prevent eternal loop
      overview.setSelection(ranges, true);
    });
    $("#overview").bind("plotselected", function (event, ranges) {
      plot.setSelection(ranges);
      alert(ranges.yaxis.from);
      // /traces?from
    });

  });
  var template;
  $(function() {
    template = Handlebars.compile($("#trace").html());
    Handlebars.registerPartial("span", $("#span-partial").html());
    $("#datepicker").datepicker({
      onSelect : function(dateText, inst) {
        var from = $(this).datepicker('getDate').getTime();
        var to = from + 24 * 60 * 60 * 1000; // from + 24 hours
      }
    });
  });
  function gettraces(from, to, low, high) {
    var queryString = 'from=' + from + '&to=' + to;
    if (low != undefined) {
      queryString += '&low=' + low;
    }
    if (high != undefined) {
      queryString += '&high=' + low;
    }
    $.getJSON('/traces?from=' + from + '&to=' + to, function(traces) {
      $('#traces').html('');
      if (traces.data.length) {
        var html = template(traces.data[0]);
        $(html).appendTo('#traces');
        $('<div>' + JSON.stringify(traces.data[0]) + '</div>').appendTo('#traces');
      } else {
        $('#traces').html('no data');
      }
    });
  }
</script>
</head>
<body>
  <h1>Traces</h1>
  <div>
    Date: <input type="text" id="datepicker">
  </div>
  <div style="float: left">
    <div id="placeholder" style="width: 500px; height: 300px"></div>
  </div>
  <div id="miniature" style="float: left; margin-left: 20px">
    <div id="overview" style="width: 166px; height: 100px"></div>
    <p id="overviewLegend" style="margin-left: 10px"></p>
  </div>
  <div style="clear: left" id="traces"></div>
</body>
</html>
